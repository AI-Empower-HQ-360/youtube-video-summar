name: Auto Create Branch from Issue

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

jobs:
  create-branch:
    runs-on: ubuntu-latest
    if: contains(github.event.label.name, 'ready')
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Create branch from issue
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issue = context.payload.issue;
            const issueNumber = issue.number;
            
            // Determine branch prefix based on labels
            let prefix = 'feature';
            if (issue.labels.some(l => l.name === 'type: bug')) {
              prefix = 'fix';
            } else if (issue.labels.some(l => l.name === 'priority: high')) {
              prefix = 'hotfix';
            }
            
            // Create branch name
            const title = issue.title
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-|-$/g, '')
              .substring(0, 50);
            
            const branchName = `${prefix}/${issueNumber}-${title}`;
            
            // Get default branch SHA
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });
            
            try {
              // Create new branch
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: ref.object.sha
              });
              
              console.log(`Created branch: ${branchName}`);
              
              // Comment on issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `üåø Branch created: \`${branchName}\`\n\nYou can start working on this issue by:\n\`\`\`bash\ngit fetch origin\ngit checkout ${branchName}\n\`\`\``
              });
              
            } catch (error) {
              if (error.status === 422) {
                console.log('Branch already exists');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `‚ÑπÔ∏è Branch \`${branchName}\` already exists.`
                });
              } else {
                throw error;
              }
            }

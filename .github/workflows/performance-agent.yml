name: Performance Monitoring Agent

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Analyze bundle size
        id: bundle
        run: |
          echo "Analyzing bundle size..."
          du -sh dist/ > bundle-size.txt
          ls -lh dist/assets/*.js | awk '{print $5, $9}' > bundle-details.txt
          
          TOTAL_SIZE=$(du -sb dist/ | awk '{print $1}')
          echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          
          cat bundle-size.txt
          cat bundle-details.txt

      - name: Check bundle size threshold
        run: |
          TOTAL_SIZE=${{ steps.bundle.outputs.total_size }}
          MAX_SIZE=2000000  # 2MB threshold
          
          if [ $TOTAL_SIZE -gt $MAX_SIZE ]; then
            echo "‚ö†Ô∏è Bundle size ($TOTAL_SIZE bytes) exceeds threshold ($MAX_SIZE bytes)"
            echo "Consider:"
            echo "- Code splitting"
            echo "- Lazy loading"
            echo "- Removing unused dependencies"
            exit 1
          else
            echo "‚úÖ Bundle size is acceptable"
          fi
        continue-on-error: true

      - name: Post bundle analysis
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const totalSize = '${{ steps.bundle.outputs.total_size }}';
            const sizeMB = (parseInt(totalSize) / 1024 / 1024).toFixed(2);
            
            let comment = '## üì¶ Bundle Size Analysis\n\n';
            comment += `**Total Size:** ${sizeMB} MB\n\n`;
            
            try {
              const details = fs.readFileSync('bundle-details.txt', 'utf-8');
              comment += '### Asset Details\n\n';
              comment += '```\n' + details + '\n```\n\n';
            } catch (e) {}
            
            if (parseFloat(sizeMB) > 2) {
              comment += '‚ö†Ô∏è **Bundle size is large**\n\n';
              comment += '### Recommendations:\n';
              comment += '- Implement code splitting\n';
              comment += '- Use dynamic imports for routes\n';
              comment += '- Remove unused dependencies\n';
              comment += '- Optimize images and assets\n';
            } else {
              comment += '‚úÖ Bundle size is acceptable\n';
            }
            
            comment += '\n---\n*Generated by Performance Agent* üöÄ';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  lighthouse-audit:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun --collect.staticDistDir=./dist || echo "Lighthouse audit completed with warnings"
        continue-on-error: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  performance-metrics:
    name: Performance Metrics Collection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Analyze dependency tree
        run: |
          echo "## Dependency Analysis" > perf-report.md
          echo "" >> perf-report.md
          npm ls --depth=0 >> perf-report.md 2>&1 || true
          
          echo "" >> perf-report.md
          echo "## Large Dependencies" >> perf-report.md
          du -sh node_modules/* | sort -rh | head -10 >> perf-report.md

      - name: Check for performance anti-patterns
        run: |
          echo "Checking for performance anti-patterns..."
          
          # Check for console.log in production code
          if grep -r "console.log" src/ --include="*.ts" --include="*.tsx" | grep -v "// @ts-ignore"; then
            echo "‚ö†Ô∏è Found console.log statements in code"
          fi
          
          # Check for large images
          find src public -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" \) -size +500k -exec ls -lh {} \; || echo "No large images found"

      - name: Upload performance report
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: performance-report
          path: perf-report.md
          retention-days: 30

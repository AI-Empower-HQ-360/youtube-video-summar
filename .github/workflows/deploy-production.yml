name: Deploy to Production

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true
        type: string

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://vidnote.ai
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd server && npm ci

      - name: Security audit
        run: npm audit --production

      - name: Run linting
        run: npm run lint

      - name: Run type check
        run: npm run type-check

      - name: Run all tests
        run: npm run test:coverage

      - name: Build frontend
        run: npm run build
        env:
          NODE_ENV: production
          VITE_API_URL: ${{ secrets.PROD_API_URL }}
          VITE_OPENAI_API_KEY: ${{ secrets.PROD_OPENAI_API_KEY }}
          VITE_GA_MEASUREMENT_ID: ${{ secrets.PROD_GA_MEASUREMENT_ID }}
          VITE_POSTHOG_KEY: ${{ secrets.PROD_POSTHOG_KEY }}

      - name: Build backend
        run: |
          cd server
          npm run build

      - name: Create deployment artifact
        run: |
          tar -czf deployment-${{ github.sha }}.tar.gz \
            dist/ \
            server/dist/ \
            server/package.json \
            server/package-lock.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: deployment-${{ github.sha }}.tar.gz
          retention-days: 30

      - name: Deploy to Production
        run: |
          echo "üöÄ Deploying to production environment..."
          # Add your production deployment commands here
          # Examples:
          # - Blue-green deployment
          # - Canary deployment
          # - Rolling update
        env:
          DEPLOY_TOKEN: ${{ secrets.PROD_DEPLOY_TOKEN }}
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}

      - name: Database migration
        run: |
          echo "üóÑÔ∏è Running database migrations..."
          # Add migration commands if needed
          # cd server && npm run migrate

      - name: Warm up caches
        run: |
          echo "üî• Warming up caches..."
          curl -X POST https://vidnote.ai/api/warmup \
            -H "Authorization: Bearer ${{ secrets.WARMUP_TOKEN }}"

      - name: Health check
        run: |
          echo "üè• Running comprehensive health checks..."
          sleep 20
          
          # Frontend health check
          curl -f https://vidnote.ai/health || exit 1
          
          # Backend health check
          curl -f https://vidnote.ai/api/health || exit 1
          
          # Database connectivity
          curl -f https://vidnote.ai/api/health/db || exit 1

      - name: Smoke tests
        run: |
          echo "üß™ Running production smoke tests..."
          npm run test:smoke:prod
        env:
          BASE_URL: https://vidnote.ai

      - name: Performance monitoring
        run: |
          echo "üìä Running performance checks..."
          npx lighthouse https://vidnote.ai \
            --only-categories=performance,accessibility,best-practices,seo \
            --chrome-flags="--headless" \
            --output=json \
            --output-path=./lighthouse-prod.json

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: Notify deployment success
        if: success()
        run: |
          echo "‚úÖ Production deployment successful!"
          echo "üåê Application URL: https://vidnote.ai"
          echo "üì¶ Version: ${{ github.sha }}"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ùå Production deployment failed! Initiating rollback..."
          # Add rollback commands here

      - name: Send notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" == "success" ]; then
            MESSAGE="‚úÖ Production deployment successful"
          else
            MESSAGE="‚ùå Production deployment failed"
          fi
          echo "$MESSAGE"
          # Add notification commands (Slack, Email, etc.)

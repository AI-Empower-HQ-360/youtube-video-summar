name: Deploy to GCP

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/gcp/**'
      - 'server/**'
      - 'src/**'
      - 'Dockerfile'
      - '.github/workflows/gcp-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  TERRAFORM_VERSION: '1.6.0'

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
      
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure environment
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "tfvars_file=environments/${ENV}.tfvars" >> $GITHUB_OUTPUT
      
      - name: Terraform Init
        working-directory: infrastructure/gcp
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.GCP_TERRAFORM_STATE_BUCKET }}" \
            -backend-config="prefix=terraform/state/${{ steps.env.outputs.environment }}"
      
      - name: Terraform Plan
        working-directory: infrastructure/gcp
        run: |
          terraform plan \
            -var-file="${{ steps.env.outputs.tfvars_file }}" \
            -var="project_id=${{ env.GCP_PROJECT_ID }}" \
            -var="region=${{ env.GCP_REGION }}" \
            -out=tfplan
      
      - name: Terraform Apply
        working-directory: infrastructure/gcp
        run: terraform apply -auto-approve tfplan
      
      - name: Build and Push Docker Image
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
          
          # Build backend image
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/youtube-summar/backend:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/youtube-summar/backend:latest \
            -f server/Dockerfile .
          
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/youtube-summar/backend:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/youtube-summar/backend:latest
      
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy youtube-summar-backend-${{ steps.env.outputs.environment }} \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/youtube-summar/backend:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --set-secrets=OPENAI_API_KEY=openai-api-key:latest,GITHUB_TOKEN=github-token:latest
      
      - name: Build and Deploy Frontend
        run: |
          # Install dependencies
          npm ci
          
          # Build frontend
          npm run build
          
          # Upload to Cloud Storage
          gsutil -m rsync -r -d dist/ gs://youtube-summar-frontend-${{ steps.env.outputs.environment }}
          
          # Set cache control
          gsutil -m setmeta -h "Cache-Control:public, max-age=3600" gs://youtube-summar-frontend-${{ steps.env.outputs.environment }}/**/*.html
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" gs://youtube-summar-frontend-${{ steps.env.outputs.environment }}/assets/**/*
      
      - name: Get Service URL
        id: service
        run: |
          SERVICE_URL=$(gcloud run services describe youtube-summar-backend-${{ steps.env.outputs.environment }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "### üöÄ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend URL:** $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** https://storage.googleapis.com/youtube-summar-frontend-${{ steps.env.outputs.environment }}/index.html" >> $GITHUB_STEP_SUMMARY
      
      - name: Run Health Check
        run: |
          echo "Waiting for service to be ready..."
          sleep 10
          
          HEALTH_CHECK_URL="${{ steps.service.outputs.url }}/api/health"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_CHECK_URL)
          
          if [ $HTTP_STATUS -eq 200 ]; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ùå Health check failed with status: $HTTP_STATUS"
            exit 1
          fi

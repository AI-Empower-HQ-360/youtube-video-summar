name: ü§ñ PR Commit Review Agent

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  commit-review:
    name: üìù Review Commit Messages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Get commits
        id: commits
        run: |
          echo "Analyzing commits in PR #${{ github.event.pull_request.number }}"
          
          # Get all commits in the PR
          COMMITS=$(git log --format="%H|%s|%b|%an|%ae" origin/${{ github.base_ref }}..${{ github.event.pull_request.head.sha }})
          
          # Save to file for processing
          echo "$COMMITS" > commits.txt
          
          # Count commits
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          
          echo "Found $COMMIT_COUNT commits to review"
      
      - name: Analyze commit messages
        id: analyze
        run: |
          # Conventional Commits patterns
          CONVENTIONAL_PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}"
          
          ISSUES=""
          WARNINGS=""
          GOOD_COMMITS=0
          BAD_COMMITS=0
          
          while IFS='|' read -r hash subject body author email; do
            if [ -z "$hash" ]; then continue; fi
            
            echo "Checking: $subject"
            
            # Check conventional commit format
            if ! echo "$subject" | grep -qE "$CONVENTIONAL_PATTERN"; then
              ISSUES="${ISSUES}\n‚ùå **Bad commit format**: \`${hash:0:7}\` - $subject"
              ISSUES="${ISSUES}\n   - Should follow: \`type(scope): description\`"
              ISSUES="${ISSUES}\n   - Example: \`feat(api): add video summary endpoint\`"
              BAD_COMMITS=$((BAD_COMMITS + 1))
            else
              GOOD_COMMITS=$((GOOD_COMMITS + 1))
            fi
            
            # Check subject length (max 72 chars recommended)
            if [ ${#subject} -gt 72 ]; then
              WARNINGS="${WARNINGS}\n‚ö†Ô∏è **Long subject**: \`${hash:0:7}\` - ${#subject} chars (recommend <72)"
            fi
            
            # Check for capitalization
            if ! echo "$subject" | grep -qE "^[a-z]+(\(.+\))?: [A-Z]"; then
              WARNINGS="${WARNINGS}\n‚ö†Ô∏è **Description not capitalized**: \`${hash:0:7}\` - $subject"
            fi
            
            # Check for period at end (should not have)
            if echo "$subject" | grep -qE "\.$"; then
              WARNINGS="${WARNINGS}\n‚ö†Ô∏è **Remove period from subject**: \`${hash:0:7}\` - $subject"
            fi
            
            # Check for WIP commits
            if echo "$subject" | grep -qiE "(wip|work in progress|tmp|temp)"; then
              ISSUES="${ISSUES}\n‚ùå **WIP commit detected**: \`${hash:0:7}\` - Should be squashed before merge"
            fi
            
            # Check for fixup commits
            if echo "$subject" | grep -qiE "^(fixup|squash)!"; then
              ISSUES="${ISSUES}\n‚ùå **Fixup commit detected**: \`${hash:0:7}\` - Should be squashed"
            fi
            
          done < commits.txt
          
          # Save results
          echo "good_commits=$GOOD_COMMITS" >> $GITHUB_OUTPUT
          echo "bad_commits=$BAD_COMMITS" >> $GITHUB_OUTPUT
          
          # Save issues and warnings to files
          echo -e "$ISSUES" > issues.txt
          echo -e "$WARNINGS" > warnings.txt
          
          echo "‚úÖ Good commits: $GOOD_COMMITS"
          echo "‚ùå Bad commits: $BAD_COMMITS"

      - name: Check commit body quality
        id: body-check
        run: |
          BODY_ISSUES=""
          
          while IFS='|' read -r hash subject body author email; do
            if [ -z "$hash" ]; then continue; fi
            
            # Check if breaking change
            if echo "$subject" | grep -qE "!:"; then
              if ! echo "$body" | grep -qiE "BREAKING CHANGE"; then
                BODY_ISSUES="${BODY_ISSUES}\n‚ö†Ô∏è **Breaking change missing details**: \`${hash:0:7}\`"
                BODY_ISSUES="${BODY_ISSUES}\n   - Add 'BREAKING CHANGE:' section in commit body"
              fi
            fi
            
            # Check for issue/ticket references
            if ! echo "$body" | grep -qE "(#[0-9]+|closes|fixes|resolves)"; then
              if ! echo "$subject" | grep -qE "#[0-9]+"; then
                BODY_ISSUES="${BODY_ISSUES}\nüí° **Consider adding issue reference**: \`${hash:0:7}\`"
              fi
            fi
            
          done < commits.txt
          
          echo -e "$BODY_ISSUES" > body-issues.txt

      - name: Analyze commit author patterns
        id: author-check
        run: |
          # Check for multiple authors
          AUTHORS=$(cut -d'|' -f4 commits.txt | sort -u | wc -l)
          echo "author_count=$AUTHORS" >> $GITHUB_OUTPUT
          
          # Check email consistency
          EMAILS=$(cut -d'|' -f5 commits.txt | sort -u)
          echo "Found $AUTHORS unique authors"
          
          # Save author list
          cut -d'|' -f4 commits.txt | sort -u > authors.txt

      - name: Generate commit quality score
        id: score
        run: |
          GOOD=${{ steps.analyze.outputs.good_commits }}
          BAD=${{ steps.analyze.outputs.bad_commits }}
          TOTAL=${{ steps.commits.outputs.commit_count }}
          
          if [ $TOTAL -eq 0 ]; then
            SCORE=100
          else
            SCORE=$(( (GOOD * 100) / TOTAL ))
          fi
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "üìä Commit Quality Score: $SCORE%"
          
          # Determine grade
          if [ $SCORE -ge 90 ]; then
            GRADE="A+ Excellent"
          elif [ $SCORE -ge 80 ]; then
            GRADE="B+ Good"
          elif [ $SCORE -ge 70 ]; then
            GRADE="C+ Fair"
          else
            GRADE="D Needs Improvement"
          fi
          
          echo "grade=$GRADE" >> $GITHUB_OUTPUT

      - name: Post commit review comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const score = '${{ steps.score.outputs.score }}';
            const grade = '${{ steps.score.outputs.grade }}';
            const goodCommits = '${{ steps.analyze.outputs.good_commits }}';
            const badCommits = '${{ steps.analyze.outputs.bad_commits }}';
            const totalCommits = '${{ steps.commits.outputs.commit_count }}';
            const authorCount = '${{ steps.author-check.outputs.author_count }}';
            
            // Read issues and warnings
            let issues = '';
            let warnings = '';
            let bodyIssues = '';
            
            try {
              issues = fs.readFileSync('issues.txt', 'utf8').trim();
              warnings = fs.readFileSync('warnings.txt', 'utf8').trim();
              bodyIssues = fs.readFileSync('body-issues.txt', 'utf8').trim();
            } catch (e) {
              console.log('No issues or warnings found');
            }
            
            // Build comment
            let comment = `## ü§ñ PR Commit Review Agent\n\n`;
            comment += `### üìä Commit Quality Score: **${score}%** (${grade})\n\n`;
            comment += `---\n\n`;
            comment += `### üìà Statistics\n\n`;
            comment += `| Metric | Value |\n`;
            comment += `|--------|-------|\n`;
            comment += `| Total Commits | ${totalCommits} |\n`;
            comment += `| ‚úÖ Well-formatted | ${goodCommits} |\n`;
            comment += `| ‚ùå Needs improvement | ${badCommits} |\n`;
            comment += `| üë• Authors | ${authorCount} |\n\n`;
            
            if (issues) {
              comment += `### ‚ùå Issues Found\n\n${issues}\n\n`;
            }
            
            if (warnings) {
              comment += `### ‚ö†Ô∏è Warnings\n\n${warnings}\n\n`;
            }
            
            if (bodyIssues) {
              comment += `### üí° Suggestions\n\n${bodyIssues}\n\n`;
            }
            
            if (!issues && !warnings) {
              comment += `### ‚úÖ All Commits Look Good!\n\n`;
              comment += `All commits follow conventional commit format. Great work! üéâ\n\n`;
            }
            
            comment += `---\n\n`;
            comment += `### üìö Commit Message Guidelines\n\n`;
            comment += `**Format:** \`type(scope): description\`\n\n`;
            comment += `**Types:**\n`;
            comment += `- \`feat\`: New feature\n`;
            comment += `- \`fix\`: Bug fix\n`;
            comment += `- \`docs\`: Documentation\n`;
            comment += `- \`style\`: Formatting\n`;
            comment += `- \`refactor\`: Code restructuring\n`;
            comment += `- \`test\`: Tests\n`;
            comment += `- \`chore\`: Maintenance\n\n`;
            comment += `**Examples:**\n`;
            comment += `- \`feat(api): add video transcription endpoint\`\n`;
            comment += `- \`fix(ui): resolve button alignment issue\`\n`;
            comment += `- \`docs(readme): update installation steps\`\n\n`;
            comment += `---\n\n`;
            comment += `*Generated by PR Commit Review Agent* ü§ñ | [Learn More](https://www.conventionalcommits.org/)\n`;
            
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            // Set status based on score
            if (score < 70) {
              core.warning('Commit quality score below 70%. Consider improving commit messages.');
            }

  commit-links:
    name: üîó Check Issue Links
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Extract issue references
        id: issues
        run: |
          # Get PR body and commits
          PR_BODY="${{ github.event.pull_request.body }}"
          COMMITS=$(git log --format="%s %b" origin/${{ github.base_ref }}..${{ github.event.pull_request.head.sha }})
          
          # Extract issue numbers
          ISSUES=$(echo "$PR_BODY $COMMITS" | grep -oE "#[0-9]+" | sort -u)
          
          if [ -z "$ISSUES" ]; then
            echo "linked=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No issue references found"
          else
            echo "linked=true" >> $GITHUB_OUTPUT
            echo "issue_list<<EOF" >> $GITHUB_OUTPUT
            echo "$ISSUES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "‚úÖ Found issue references: $ISSUES"
          fi

      - name: Comment on missing issue links
        if: steps.issues.outputs.linked == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const comment = `## üí° Tip: Link to Issues\n\n` +
              `This PR doesn't reference any issues. Consider linking to:\n\n` +
              `- \`Closes #123\` - Closes an issue\n` +
              `- \`Fixes #123\` - Fixes a bug\n` +
              `- \`Resolves #123\` - Resolves an issue\n` +
              `- \`Related to #123\` - Related work\n\n` +
              `Add these to your PR description or commit messages.\n\n` +
              `---\n` +
              `*This is a suggestion from PR Commit Review Agent* ü§ñ`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

name: Auto Create PR

on:
  push:
    branches-ignore:
      - main
      - develop

permissions:
  pull-requests: write
  contents: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Create Pull Request
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            
            // Check if PR already exists
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });
            
            if (existingPRs.length > 0) {
              console.log('PR already exists');
              return;
            }
            
            // Extract issue number from branch name (e.g., feature/9-multi-language)
            const issueMatch = branch.match(/(\d+)/);
            const issueNumber = issueMatch ? issueMatch[1] : null;
            
            let title = branch.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            let body = `Automated PR for branch: ${branch}`;
            
            if (issueNumber) {
              title = `Fix #${issueNumber}: ${title}`;
              body += `\n\nCloses #${issueNumber}`;
            }
            
            // Create PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              head: branch,
              base: 'main',
              body: body,
              draft: false
            });
            
            console.log(`Created PR #${pr.number}: ${pr.html_url}`);
            
            // Auto-assign to pusher
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              assignees: [context.actor]
            });
            
            // Add labels based on branch prefix
            const labels = [];
            if (branch.startsWith('feature/')) labels.push('type: feature');
            if (branch.startsWith('fix/') || branch.startsWith('bugfix/')) labels.push('type: bug');
            if (branch.startsWith('hotfix/')) labels.push('type: bug', 'priority: high');
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: labels
              });
            }

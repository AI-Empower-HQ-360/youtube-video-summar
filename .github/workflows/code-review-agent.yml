name: Code Review Agent

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: eslint
        run: |
          npm run lint -- --format json --output-file eslint-report.json || true
          echo "results<<EOF" >> $GITHUB_OUTPUT
          cat eslint-report.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Run TypeScript Check
        id: typescript
        run: |
          npx tsc --noEmit --pretty false > typescript-errors.txt 2>&1 || true
          echo "errors<<EOF" >> $GITHUB_OUTPUT
          cat typescript-errors.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check Code Complexity
        id: complexity
        run: |
          npx ts-node-esm -e "
          import { glob } from 'glob';
          import { readFileSync } from 'fs';
          import { parse } from '@typescript-eslint/typescript-estree';
          
          const files = glob.sync('src/**/*.{ts,tsx}');
          const complexFiles = [];
          
          for (const file of files) {
            const content = readFileSync(file, 'utf-8');
            const lines = content.split('\\n').length;
            if (lines > 300) {
              complexFiles.push({ file, lines });
            }
          }
          
          if (complexFiles.length > 0) {
            console.log('Large files found:');
            complexFiles.forEach(f => console.log(\`- \${f.file}: \${f.lines} lines\`));
          }
          " || echo "No large files found"
        continue-on-error: true

      - name: Post Review Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let comment = '## ü§ñ Code Review Agent Report\n\n';
            
            // ESLint Results
            try {
              const eslintData = JSON.parse(fs.readFileSync('eslint-report.json', 'utf-8'));
              const errorCount = eslintData.reduce((sum, file) => sum + file.errorCount, 0);
              const warningCount = eslintData.reduce((sum, file) => sum + file.warningCount, 0);
              
              comment += `### ESLint Analysis\n`;
              comment += `- ‚ùå Errors: ${errorCount}\n`;
              comment += `- ‚ö†Ô∏è Warnings: ${warningCount}\n\n`;
              
              if (errorCount > 0 || warningCount > 0) {
                comment += `<details><summary>View Details</summary>\n\n`;
                eslintData.forEach(file => {
                  if (file.messages.length > 0) {
                    comment += `**${file.filePath}**\n`;
                    file.messages.slice(0, 5).forEach(msg => {
                      const emoji = msg.severity === 2 ? '‚ùå' : '‚ö†Ô∏è';
                      comment += `- ${emoji} Line ${msg.line}: ${msg.message}\n`;
                    });
                  }
                });
                comment += `\n</details>\n\n`;
              }
            } catch (e) {
              comment += '### ESLint Analysis\n‚úÖ No issues found\n\n';
            }
            
            // TypeScript Results
            const tsErrors = '${{ steps.typescript.outputs.errors }}';
            if (tsErrors && tsErrors.length > 0) {
              comment += `### TypeScript Check\n`;
              comment += `‚ö†Ô∏è Type errors detected\n\n`;
              comment += `<details><summary>View Errors</summary>\n\n\`\`\`\n${tsErrors.slice(0, 1000)}\`\`\`\n</details>\n\n`;
            } else {
              comment += `### TypeScript Check\n‚úÖ No type errors\n\n`;
            }
            
            // Recommendations
            comment += `### üìã Recommendations\n\n`;
            comment += `- ‚úÖ Run \`npm run lint\` locally before pushing\n`;
            comment += `- ‚úÖ Run \`npm run type-check\` to catch type errors\n`;
            comment += `- ‚úÖ Consider breaking large files into smaller modules\n`;
            comment += `- ‚úÖ Add tests for new functionality\n\n`;
            
            comment += `---\n*Generated by Code Review Agent* ü§ñ`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  test-coverage:
    name: Test Coverage Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage || true
        continue-on-error: true

      - name: Coverage Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let comment = '## üìä Test Coverage Report\n\n';
            
            try {
              const coverageData = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf-8'));
              const total = coverageData.total;
              
              comment += `| Metric | Coverage | Status |\n`;
              comment += `|--------|----------|--------|\n`;
              
              const metrics = [
                ['Lines', total.lines.pct],
                ['Statements', total.statements.pct],
                ['Functions', total.functions.pct],
                ['Branches', total.branches.pct]
              ];
              
              metrics.forEach(([name, pct]) => {
                const status = pct >= 80 ? '‚úÖ' : pct >= 60 ? '‚ö†Ô∏è' : '‚ùå';
                comment += `| ${name} | ${pct.toFixed(2)}% | ${status} |\n`;
              });
              
              comment += `\n`;
              if (total.lines.pct < 80) {
                comment += `‚ö†Ô∏è **Coverage below 80% target**\n`;
                comment += `Consider adding more tests to improve coverage.\n\n`;
              } else {
                comment += `‚úÖ **Great coverage!** Keep it up!\n\n`;
              }
            } catch (e) {
              comment += `‚ö†Ô∏è Could not parse coverage data\n\n`;
            }
            
            comment += `---\n*Generated by Test Coverage Agent* üìä`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Run npm audit
        id: npm-audit
        run: |
          npm audit --json > npm-audit.json || true
          echo "vulnerabilities=$(cat npm-audit.json | jq -r '.metadata | "\(.vulnerabilities.total)"')" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check for secrets
        id: secrets
        run: |
          echo "Scanning for potential secrets..."
          git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(api[_-]?key|password|secret|token|auth)" || echo "No secrets found"
        continue-on-error: true

      - name: Post Security Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const vulnCount = '${{ steps.npm-audit.outputs.vulnerabilities }}' || '0';
            
            let comment = '## üîí Security Scan Report\n\n';
            comment += `### npm audit\n`;
            
            if (vulnCount === '0' || vulnCount === 'null') {
              comment += `‚úÖ No vulnerabilities found\n\n`;
            } else {
              comment += `‚ö†Ô∏è Found ${vulnCount} vulnerabilities\n`;
              comment += `Run \`npm audit fix\` to resolve automatically fixable issues.\n\n`;
            }
            
            comment += `### Secret Detection\n`;
            comment += `‚úÖ No obvious secrets detected in code\n\n`;
            
            comment += `### üõ°Ô∏è Security Checklist\n`;
            comment += `- [ ] No API keys or secrets in code\n`;
            comment += `- [ ] Environment variables used for sensitive data\n`;
            comment += `- [ ] Input validation implemented\n`;
            comment += `- [ ] HTTPS used for external requests\n`;
            comment += `- [ ] Dependencies regularly updated\n\n`;
            
            comment += `---\n*Generated by Security Agent* üîí`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
